@model ProfileVisibilityViewModel

<div class="tab-pane fade show active" id="v-pills-visibility-tab">
    <div class="top-box d-flex justify-content-between align-items-center">
        <h4>Profile Visibility</h4>
    </div>
    <hr>

    @{
        var groups = Model.VisibilityItems
            .GroupBy(x => x.Group)
            .ToList();
    }

    @foreach (var group in groups)
    {
        <div class="table-responsive table-primary mb-4">
            <table class="table table-bordered align-middle mb-0">
                <thead class="bg-primary text-white">
                    <tr>
                        <th class="p-3 fs-6">@group.Key</th>
                        <th class="p-3 fs-6">Visibility</th>
                    </tr>
                </thead>

                <tbody>
                @foreach (var item in group)
                {
                    <tr>
                        <td class="table-title fs-6 fw-semibold p-3 text-body">
                            @item.Label
                        </td>
                        <td class="p-3">
                            <select data-field="@item.Field" class="form-select" id="visibilitySelect">
                                <option value="OnlyMe" selected="@(item.Visibility == VisibilityLevel.OnlyMe)"> Only Me </option>
                                <option value="Everyone" selected="@(item.Visibility == VisibilityLevel.Everyone)"> Everyone </option>
                                <option value="Friends" selected="@(item.Visibility == VisibilityLevel.Friends)"> Friends </option>
                            </select>
                        </td>
                    </tr>
                }
                </tbody>
            </table>
        </div>
    }
</div>
<script>
    $(document).on("change", "#visibilitySelect", function () {
        const field = $(this).data("field");  
        const visibility = $(this).val();    
        console.log(field);
        console.log(visibility);

        $.ajax({
            url: "/User/Profile/UpdateVisibility",
            type: "POST",
            data: { field: field, visibility: visibility },
            success: function () {
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true,
                    customClass: {
                        title: 'custom-toast-title'
                    },
                    didOpen: (toast) => {
                        toast.addEventListener('mouseenter', Swal.stopTimer)
                        toast.addEventListener('mouseleave', Swal.resumeTimer)
                    }
                });

                Toast.fire({
                    icon: 'success',
                    title: `${field} field changed to ${visibility}`
                });
            },
            error: function () {
                alert("Could not update visibility");
            }
        });
    });
</script>
